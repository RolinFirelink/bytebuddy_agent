# ByteBuddy Agent å‚æ•°é…ç½®ä½¿ç”¨è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°ä¸º ByteBuddy Agent æ·»åŠ äº†**é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è‡ªå®šä¹‰åŒ…è·¯å¾„**çš„åŠŸèƒ½ã€‚ç°åœ¨ä½ å¯ä»¥åœ¨ä»»ä½•é¡¹ç›®ä¸­ä½¿ç”¨è¿™ä¸ªæ¢é’ˆï¼Œåªéœ€é€šè¿‡è°ƒæ•´å‚æ•°å³å¯æŒ‡å®šè¦æ‹¦æˆªçš„åŒ…è·¯å¾„ï¼Œæ— éœ€ä¿®æ”¹ä»£ç ã€‚

---

## ğŸ¯ ä¸»è¦æ”¹åŠ¨

### æ”¹åŠ¨å†…å®¹
1. âœ… **æ‰€æœ‰æ‹¦æˆªæ¨¡å¼éƒ½æ”¯æŒè‡ªå®šä¹‰åŒ…è·¯å¾„**
2. âœ… **å‚æ•°æ ¼å¼ç»Ÿä¸€ä¸ºï¼š`æ¨¡å¼:åŒ…è·¯å¾„`**
3. âœ… **æ”¯æŒå¤šä¸ªåŒ…è·¯å¾„ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰**
4. âœ… **ç§»é™¤äº†ç¡¬ç¼–ç çš„åŒ…è·¯å¾„**

### æ”¹åŠ¨æ–‡ä»¶
- `src/main/java/org/example/agent/AgentMain.java` - ä¸»å…¥å£ï¼Œæ·»åŠ äº†å‚æ•°è§£æé€»è¾‘

---

## ğŸ“– å‚æ•°æ ¼å¼è¯´æ˜

### åŸºæœ¬æ ¼å¼
```
æ¨¡å¼:åŒ…è·¯å¾„
```

### æ”¯æŒçš„æ¨¡å¼

| æ¨¡å¼ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `default` æˆ– æ— å‚æ•° | æ‹¦æˆª `@RestController`/`@Controller` æ³¨è§£çš„ç±» | æ— å‚æ•° |
| `package:åŒ…è·¯å¾„` | ä½¿ç”¨åŒ…è·¯å¾„åŒ¹é…æ‹¦æˆªå™¨ | `package:com.example.service` |
| `advice:åŒ…è·¯å¾„` | ä½¿ç”¨ Advice æ–¹å¼æ‹¦æˆªï¼ˆæ€§èƒ½æ›´å¥½ï¼‰ | `advice:com.example.service` |
| `advanced:åŒ…è·¯å¾„` | ä½¿ç”¨é«˜çº§æ‹¦æˆªå™¨ï¼ˆæ•è·æ›´å¤šä¿¡æ¯ï¼‰ | `advanced:com.example.service` |
| `all:åŒ…è·¯å¾„1,åŒ…è·¯å¾„2` | å¯ç”¨æ‰€æœ‰æ‹¦æˆªæ–¹å¼ï¼Œæ”¯æŒå¤šä¸ªåŒ… | `all:com.example.service,com.example.dao` |

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. é»˜è®¤æ¨¡å¼ï¼ˆæ‹¦æˆª Controller æ³¨è§£ï¼‰

```bash
java -javaagent:target/bytebuddy_agent-1.0-SNAPSHOT.jar -cp target/classes com.example.Main
```

**è¯´æ˜**ï¼šæ‹¦æˆªæ‰€æœ‰å¸¦æœ‰ `@RestController` æˆ– `@Controller` æ³¨è§£çš„ç±»ã€‚

---

### 2. åŒ…è·¯å¾„åŒ¹é…æ¨¡å¼

#### æ‹¦æˆªå•ä¸ªåŒ…
```bash
java -javaagent:target/bytebuddy_agent-1.0-SNAPSHOT.jar=package:com.example.service -cp target/classes com.example.Main
```

#### æ‹¦æˆªä¸åŒé¡¹ç›®çš„åŒ…
```bash
# æ‹¦æˆª service åŒ…
java -javaagent:target/bytebuddy_agent-1.0-SNAPSHOT.jar=package:com.myapp.service -cp target/classes com.myapp.Main

# æ‹¦æˆª controller åŒ…
java -javaagent:target/bytebuddy_agent-1.0-SNAPSHOT.jar=package:com.myapp.controller -cp target/classes com.myapp.Main

# æ‹¦æˆª dao åŒ…
java -javaagent:target/bytebuddy_agent-1.0-SNAPSHOT.jar=package:com.myapp.dao -cp target/classes com.myapp.Main
```

**è¯´æ˜**ï¼šæ‹¦æˆªæŒ‡å®šåŒ…è·¯å¾„ä¸‹çš„æ‰€æœ‰ public éé™æ€éæ„é€ æ–¹æ³•ã€‚

---

### 3. Advice æ¨¡å¼ï¼ˆé«˜æ€§èƒ½ï¼‰

```bash
java -javaagent:target/bytebuddy_agent-1.0-SNAPSHOT.jar=advice:com.example.service -cp target/classes com.example.Main
```

**è¯´æ˜**ï¼šä½¿ç”¨ ByteBuddy çš„ Advice API è¿›è¡Œæ‹¦æˆªï¼Œæ€§èƒ½æ¯” MethodDelegation æ›´å¥½ã€‚

---

### 4. é«˜çº§æ‹¦æˆªå™¨æ¨¡å¼ï¼ˆè¯¦ç»†ä¿¡æ¯ï¼‰

```bash
java -javaagent:target/bytebuddy_agent-1.0-SNAPSHOT.jar=advanced:com.example.service -cp target/classes com.example.Main
```

**è¯´æ˜**ï¼šæ•è·è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
- ç±»ä¿¡æ¯ï¼ˆå®Œæ•´ç±»åã€åŒ…åã€ç±»åŠ è½½å™¨ï¼‰
- æ–¹æ³•ä¿¡æ¯ï¼ˆå®Œæ•´æ–¹æ³•ç­¾åã€å‚æ•°ç±»å‹ã€è¿”å›ç±»å‹ï¼‰
- çº¿ç¨‹ä¿¡æ¯ï¼ˆçº¿ç¨‹IDã€çº¿ç¨‹åã€çº¿ç¨‹çŠ¶æ€ã€ä¼˜å…ˆçº§ï¼‰
- è°ƒç”¨æ ˆä¿¡æ¯ï¼ˆå‰5å±‚è°ƒç”¨æ ˆï¼‰
- æ–¹æ³•å‚æ•°å’Œè¿”å›å€¼ï¼ˆç±»å‹ã€å€¼ã€hashCodeï¼‰
- å¼‚å¸¸ä¿¡æ¯ï¼ˆç±»å‹ã€æ¶ˆæ¯ã€å †æ ˆï¼‰

---

### 5. æ‰€æœ‰æ¨¡å¼ï¼ˆå¤šä¸ªåŒ…ï¼‰

```bash
java -javaagent:target/bytebuddy_agent-1.0-SNAPSHOT.jar=all:com.example.service,com.example.dao -cp target/classes com.example.Main
```

**è¯´æ˜**ï¼š
- æ‹¦æˆª `@RestController`/`@Controller` æ³¨è§£çš„ç±»
- æ‹¦æˆªæ‰€æœ‰æŒ‡å®šçš„åŒ…è·¯å¾„
- å¦‚æœåŒ…ååŒ…å« "dao"ï¼Œä¼šä½¿ç”¨é«˜çº§æ‹¦æˆªå™¨

---

## ğŸ”§ å®é™…ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šæµ‹è¯• Spring Boot é¡¹ç›®

å‡è®¾ä½ çš„é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š
```
com.myapp
â”œâ”€â”€ controller
â”‚   â””â”€â”€ UserController.java
â”œâ”€â”€ service
â”‚   â””â”€â”€ UserService.java
â””â”€â”€ dao
    â””â”€â”€ UserDao.java
```

#### æ‹¦æˆª service åŒ…
```bash
java -javaagent:bytebuddy_agent-1.0-SNAPSHOT.jar=package:com.myapp.service \
     -jar myapp.jar
```

#### æ‹¦æˆª controller åŒ…
```bash
java -javaagent:bytebuddy_agent-1.0-SNAPSHOT.jar=package:com.myapp.controller \
     -jar myapp.jar
```

#### åŒæ—¶æ‹¦æˆªå¤šä¸ªåŒ…
```bash
java -javaagent:bytebuddy_agent-1.0-SNAPSHOT.jar=all:com.myapp.service,com.myapp.dao \
     -jar myapp.jar
```

---

### åœºæ™¯ 2ï¼šæ€§èƒ½æµ‹è¯•ï¼ˆä½¿ç”¨ Advice æ¨¡å¼ï¼‰

```bash
java -javaagent:bytebuddy_agent-1.0-SNAPSHOT.jar=advice:com.myapp.service \
     -jar myapp.jar
```

---

### åœºæ™¯ 3ï¼šè°ƒè¯•é—®é¢˜ï¼ˆä½¿ç”¨é«˜çº§æ‹¦æˆªå™¨ï¼‰

```bash
java -javaagent:bytebuddy_agent-1.0-SNAPSHOT.jar=advanced:com.myapp.service \
     -jar myapp.jar
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. åŒ…è·¯å¾„æ ¼å¼
- âœ… **æ­£ç¡®**ï¼š`com.example.service`ï¼ˆä½¿ç”¨ç‚¹åˆ†éš”ï¼‰
- âŒ **é”™è¯¯**ï¼š`com/example/service`ï¼ˆä¸è¦ä½¿ç”¨æ–œæ ï¼‰

### 2. åŒ…è·¯å¾„åŒ¹é…è§„åˆ™
- ä½¿ç”¨ `nameStartsWith` åŒ¹é…ï¼Œä¼šæ‹¦æˆª**ä»¥æŒ‡å®šåŒ…è·¯å¾„å¼€å¤´çš„æ‰€æœ‰ç±»**
- ä¾‹å¦‚ï¼š`package:com.example.service` ä¼šæ‹¦æˆªï¼š
  - `com.example.service.UserService`
  - `com.example.service.impl.UserServiceImpl`
  - `com.example.service.mapper.UserMapper`

### 3. å¤šä¸ªåŒ…è·¯å¾„
- ä½¿ç”¨é€—å·åˆ†éš”ï¼Œ**ä¸è¦æœ‰ç©ºæ ¼**
- âœ… **æ­£ç¡®**ï¼š`all:com.example.service,com.example.dao`
- âŒ **é”™è¯¯**ï¼š`all:com.example.service, com.example.dao`ï¼ˆé€—å·åæœ‰ç©ºæ ¼ä¼šè¢«å½“ä½œåŒ…åçš„ä¸€éƒ¨åˆ†ï¼‰

### 4. å‚æ•°é”™è¯¯å¤„ç†
å¦‚æœå‚æ•°æ ¼å¼ä¸æ­£ç¡®ï¼ŒAgent ä¼šè¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶æç¤ºæ­£ç¡®çš„æ ¼å¼ï¼š
```
[é”™è¯¯] package æ¨¡å¼éœ€è¦æŒ‡å®šåŒ…è·¯å¾„ï¼Œæ ¼å¼: package:åŒ…è·¯å¾„
[é”™è¯¯] ç¤ºä¾‹: package:com.example.service
```

### 5. ç±»åŠ è½½æ—¶æœº
- Agent åªèƒ½æ‹¦æˆªåœ¨ Agent å¯åŠ¨**ä¹‹å**åŠ è½½çš„ç±»
- å¦‚æœç±»åœ¨ Agent å¯åŠ¨å‰å·²ç»åŠ è½½ï¼Œéœ€è¦å¯ç”¨ç±»é‡è½¬æ¢åŠŸèƒ½ï¼ˆå·²å¯ç”¨ï¼‰

---

## ğŸ“Š æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | default | package | advice | advanced | all |
|------|---------|---------|--------|----------|-----|
| åŒ¹é…æ–¹å¼ | æ³¨è§£ | åŒ…è·¯å¾„ | åŒ…è·¯å¾„ | åŒ…è·¯å¾„ | æ³¨è§£+åŒ…è·¯å¾„ |
| æ€§èƒ½ | ä¸­ç­‰ | ä¸­ç­‰ | **é«˜** | ä½ | ä½ |
| ä¿¡æ¯è¯¦ç»†åº¦ | ä¸­ç­‰ | ä¸­ç­‰ | ä¸­ç­‰ | **é«˜** | ä¸­ç­‰ |
| éœ€è¦å‚æ•° | âŒ | âœ… | âœ… | âœ… | âœ… |
| é€‚ç”¨åœºæ™¯ | Spring Web | é€šç”¨ | ç”Ÿäº§ç¯å¢ƒ | è°ƒè¯• | æ¼”ç¤º |

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. å¼€å‘ç¯å¢ƒ
ä½¿ç”¨ `advanced` æ¨¡å¼è·å–è¯¦ç»†ä¿¡æ¯ï¼š
```bash
java -javaagent:bytebuddy_agent-1.0-SNAPSHOT.jar=advanced:com.example.service \
     -jar app.jar
```

### 2. ç”Ÿäº§ç¯å¢ƒ
ä½¿ç”¨ `advice` æ¨¡å¼è·å¾—æ›´å¥½æ€§èƒ½ï¼š
```bash
java -javaagent:bytebuddy_agent-1.0-SNAPSHOT.jar=advice:com.example.service \
     -jar app.jar
```

### 3. æ€§èƒ½æµ‹è¯•
ä½¿ç”¨ `package` æ¨¡å¼ï¼Œæ€§èƒ½é€‚ä¸­ï¼Œä¿¡æ¯å®Œæ•´ï¼š
```bash
java -javaagent:bytebuddy_agent-1.0-SNAPSHOT.jar=package:com.example.service \
     -jar app.jar
```

### 4. å¤šåŒ…ç›‘æ§
ä½¿ç”¨ `all` æ¨¡å¼åŒæ—¶ç›‘æ§å¤šä¸ªåŒ…ï¼š
```bash
java -javaagent:bytebuddy_agent-1.0-SNAPSHOT.jar=all:com.example.service,com.example.dao,com.example.controller \
     -jar app.jar
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹ Agent å¯åŠ¨ä¿¡æ¯
Agent å¯åŠ¨æ—¶ä¼šè¾“å‡ºé…ç½®ä¿¡æ¯ï¼š
```
========================================
ByteBuddy Agent å·²å¯åŠ¨ï¼
Agent å‚æ•°: package:com.example.service
[é…ç½®] æ‹¦æˆªæ¨¡å¼: package
[é…ç½®] æ‹¦æˆªåŒ…è·¯å¾„: com.example.service
[é…ç½®] ä½¿ç”¨åŒ…è·¯å¾„åŒ¹é…æ‹¦æˆªå™¨ï¼šæ‹¦æˆª com.example.service åŒ…ä¸‹çš„ç±»
Agent å®‰è£…å®Œæˆï¼
========================================
```

### 2. æŸ¥çœ‹ç±»åŠ è½½äº‹ä»¶
ç›‘å¬å™¨ä¼šè¾“å‡ºç±»åŠ è½½å’Œè½¬æ¢ä¿¡æ¯ï¼š
```
[Listener] å‘ç°ç±»: com.example.service.UserService
[Listener] âœ“ è½¬æ¢ç±»: com.example.service.UserService
```

### 3. éªŒè¯æ‹¦æˆªæ˜¯å¦ç”Ÿæ•ˆ
å¦‚æœçœ‹åˆ°æ‹¦æˆªå™¨çš„æ—¥å¿—è¾“å‡ºï¼Œè¯´æ˜æ‹¦æˆªæˆåŠŸï¼š
```
[PackageMatcher] ========================================
[PackageMatcher] åŒ…è·¯å¾„: com.example.service
[PackageMatcher] å®Œæ•´ç±»å: com.example.service.UserService
...
```

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæ²¡æœ‰æ‹¦æˆªåˆ°ç±»ï¼Ÿ
**A**: å¯èƒ½çš„åŸå› ï¼š
1. åŒ…è·¯å¾„ä¸æ­£ç¡®ï¼Œæ£€æŸ¥åŒ…åæ˜¯å¦åŒ¹é…
2. ç±»åœ¨ Agent å¯åŠ¨å‰å·²ç»åŠ è½½
3. ç±»ä¸åœ¨æŒ‡å®šçš„åŒ…è·¯å¾„ä¸‹

### Q2: å¦‚ä½•æ‹¦æˆªå¤šä¸ªä¸åŒçš„åŒ…ï¼Ÿ
**A**: ä½¿ç”¨ `all` æ¨¡å¼ï¼Œç”¨é€—å·åˆ†éš”ï¼š
```bash
java -javaagent:bytebuddy_agent-1.0-SNAPSHOT.jar=all:com.example.service,com.example.dao \
     -jar app.jar
```

### Q3: æ€§èƒ½å½±å“å¤§å—ï¼Ÿ
**A**: 
- `advice` æ¨¡å¼æ€§èƒ½å½±å“æœ€å°
- `advanced` æ¨¡å¼æ€§èƒ½å½±å“æœ€å¤§ï¼ˆå› ä¸ºæ•è·æ›´å¤šä¿¡æ¯ï¼‰
- å»ºè®®ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ `advice` æˆ– `package` æ¨¡å¼

### Q4: å¯ä»¥æ‹¦æˆªç§æœ‰æ–¹æ³•å—ï¼Ÿ
**A**: å½“å‰é…ç½®åªæ‹¦æˆª public æ–¹æ³•ã€‚å¦‚æœéœ€è¦æ‹¦æˆªç§æœ‰æ–¹æ³•ï¼Œéœ€è¦ä¿®æ”¹ä»£ç ä¸­çš„åŒ¹é…å™¨ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **è¯¦ç»†åŠŸèƒ½è¯´æ˜**ï¼šæŸ¥çœ‹ `ByteBuddyåŠŸèƒ½æ‰©å±•è¯´æ˜æ–‡æ¡£.md`
- **å¿«é€Ÿå¼€å§‹**ï¼šæŸ¥çœ‹ `å¿«é€Ÿå¼€å§‹æŒ‡å—.md`

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0  
**æœ€åæ›´æ–°**: 2024å¹´  
**æ›´æ–°å†…å®¹**: æ·»åŠ è‡ªå®šä¹‰åŒ…è·¯å¾„æ”¯æŒ

